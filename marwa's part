#include <iostream>
#include <string>
#include <vector>
#include <fstream>
using namespace std;

// -------------------- Car (Base Class) --------------------
class Car {
protected:
    int id;
    string brand;
    string model;
    double dailyRate;
    bool available;

public:
    static int totalCars;

    Car(int i, string b, string m, double r) {
        id = i;
        brand = b;
        model = m;
        dailyRate = r;
        available = true;
        totalCars++;
    }

    virtual double calculateRent(int days) { return days * dailyRate; }
    virtual string getType() { return "Car"; }

    int getID() { return id; }
    string getBrand() { return brand; }
    string getModel() { return model; }
    double getRate() { return dailyRate; }
    bool isAvailable() { return available; }

    void setAvailable(bool a) { available = a; }

    void display() {
        cout << id << " | " << brand << " " << model
             << " | Type: " << getType()
             << " | Rate: $" << dailyRate
             << " | " << (available ? "Available" : "Rented") << endl;
    }
};
int Car::totalCars = 0;

// -------------------- Derived Car Types --------------------
class SportsCar : public Car {
public:
    SportsCar(int i, string b, string m, double r) : Car(i, b, m, r) {}
    double calculateRent(int days) { return Car::calculateRent(days) * 1.15; }
    string getType() { return "Sports"; }
};

class LuxuryCar : public Car {
public:
    LuxuryCar(int i, string b, string m, double r) : Car(i, b, m, r) {}
    double calculateRent(int days) { return Car::calculateRent(days) * 1.10; }
    string getType() { return "Luxury"; }
};

class StandardCar : public Car {
public:
    StandardCar(int i, string b, string m, double r) : Car(i, b, m, r) {}
    string getType() { return "Standard"; }
};

class BaseCar : public Car {
public:
    BaseCar(int i, string b, string m, double r) : Car(i, b, m, r) {}
    string getType() { return "Base"; }
};

// -------------------- Customer --------------------
class Customer {
    string name;
    string cnic;
public:
    Customer(string n, string id) {
        name = n;
        cnic = id;
    }
    string getName() { return name; }
    string getCNIC() { return cnic; }
};

// -------------------- Booking --------------------
class Booking {
public:
    int carID;
    string customerName;
    string customerCNIC;
    int days;
    double amount;
};

// -------------------- Rental System --------------------
class RentalSystem {
    vector<Car*> cars;
    vector<Booking> bookings;

public:
    void addCar(Car* c) { cars.push_back(c); }

    void addNewCar() {
        int id = cars.size() + 1;
        string brand, model, type;
        double rate;

        cout << "\nEnter Car Type (Sports/Luxury/Standard/Base): ";
        cin >> type;
        cout << "Enter Car Brand: ";
        cin >> brand;
        cout << "Enter Car Model: ";
        cin.ignore();
        getline(cin, model);
        cout << "Enter Daily Rate ($): ";
        cin >> rate;

        if (type == "Sports" || type == "sports")
            cars.push_back(new SportsCar(id, brand, model, rate));
        else if (type == "Luxury" || type == "luxury")
            cars.push_back(new LuxuryCar(id, brand, model, rate));
        else if (type == "Standard" || type == "standard")
            cars.push_back(new StandardCar(id, brand, model, rate));
        else
            cars.push_back(new BaseCar(id, brand, model, rate));

        cout << "✅ New car added successfully!\n";
    }

    void viewCars() {
        cout << "\n--- Available Cars ---\n";
        for (auto c : cars)
            c->display();
    }

    bool isCarRentedByCustomer(string cnic) {
        for (auto &b : bookings)
            if (b.customerCNIC == cnic)
                return true;
        return false;
    }

    void rentCar(string customerName, string customerCNIC) {
        if (isCarRentedByCustomer(customerCNIC)) {
            cout << "⚠ You already have a rented car. Please return it or change it.\n";
            return;
        }

        int id, days;
        cout << "Enter Car ID to rent: ";
        cin >> id;

        Car* chosen = NULL;
        for (auto c : cars) {
            if (c->getID() == id) {
                chosen = c;
                break;
            }
        }

        if (chosen == NULL) {
            cout << "❌ Car not found!\n";
            return;
        }
        if (!chosen->isAvailable()) {
            cout << "❌ Sorry, this car is already rented.\n";
            return;
        }

        cout << "Enter number of days: ";
        cin >> days;
        if (days <= 0) {
            cout << "❌ Invalid number of days!\n";
            return;
        }

        double total = chosen->calculateRent(days);
        chosen->setAvailable(false);

        Booking b;
        b.carID = id;
        b.customerName = customerName;
        b.customerCNIC = customerCNIC;
        b.days = days;
        b.amount = total;
        bookings.push_back(b);

        ofstream file("rental_log.txt", ios::app);
        file << "Customer: " << customerName
             << " (CNIC: " << customerCNIC << ")"
             << ", Car: " << chosen->getBrand() << " " << chosen->getModel()
             << ", Car ID: " << id
             << ", Days: " << days
             << ", Amount: $" << total << endl;
        file.close();

        cout << "✅ Car rented successfully! Total rent = $" << total << "\n";
    }

    void changeCar(string customerCNIC) {
        int newID;
        bool found = false;

        // Find current booking
        for (auto &b : bookings) {
            if (b.customerCNIC == customerCNIC) {
                found = true;

                // Make old car available
                for (auto c : cars)
                    if (c->getID() == b.carID)
                        c->setAvailable(true);

                cout << "Enter new Car ID to rent: ";
                cin >> newID;

                Car* newCar = NULL;
                for (auto c : cars)
                    if (c->getID() == newID)
                        newCar = c;

                if (newCar == NULL) {
                    cout << "❌ New car not found!\n";
                    return;
                }
                if (!newCar->isAvailable()) {
                    cout << "❌ That car is already rented.\n";
                    return;
                }

                int newDays;
                cout << "Enter number of days: ";
                cin >> newDays;

                b.carID = newID;
                b.days = newDays;
                b.amount = newCar->calculateRent(newDays);

                newCar->setAvailable(false);
                cout << "✅ Car changed successfully! New total: $" << b.amount << "\n";
                return;
            }
        }
        if (!found) cout << "⚠ No active booking found for your CNIC.\n";
    }

    void returnCar(string cnic) {
        bool found = false;
        for (size_t i = 0; i < bookings.size(); i++) {
            if (bookings[i].customerCNIC == cnic) {
                for (auto c : cars)
                    if (c->getID() == bookings[i].carID)
                        c->setAvailable(true);

                bookings.erase(bookings.begin() + i);
                cout << "✅ Car returned successfully!\n";
                found = true;
                break;
            }
        }
        if (!found) cout << "❌ No booking found under your CNIC.\n";
    }

    void viewBookings() {
        cout << "\n--- All Bookings ---\n";
        for (auto &b : bookings)
            cout << "Customer: " << b.customerName
                 << " | CNIC: " << b.customerCNIC
                 << " | Car ID: " << b.carID
                 << " | Days: " << b.days
                 << " | Amount: $" << b.amount << endl;
    }
};
